## 一、商品审核背景介绍

转转公司是一家主营二手交易的电商公司，根据交易主体的不同，可以形成C2C、C2B、B2C等交易关系。比如个人在转转app的自由市场是发布商品进行售卖属于C2C、转转公司的手机上门回收业务属于C2B，个人在app上选购官方提供质保与售后的商品属于B2C业务。整个交易环节中，有一个非常重要的环节是审核环节。

### 1.1、审核的目的和内容
审核的目的是使平台生态向更好的方向发展，提升用户在平台上的使用体验，增加用户粘性。
对于c2c业务发布的商品，我们有专门的风控部门进行审核，主要审核是否疑似诈骗、是否涉黄涉恐涉证等。对于B2C业务，其审核内容则主要包含审核商品的基本信息、审核商品的展示效果等。

### 1.2、当前审核业务中存在的问题
转转app上目前上架的商品都是使用人工审核的方式，这种方式存在的问题有下面几点
1. 人力成本较高,而且随着日益增长的交易量，人工审核全部商品的方式越来越难以为继
2. 由于审核量大，长时间的审核后会出现疲劳的现象，导致审核效果下降
3. 人工审核的过程中带有部分主观性，导致人工审核结果的一致性不佳

### 1.3、算法为业务赋能
为了解决业务中遇见的问题，我们使用了图像领域相关的分类、回归、检测等技术，大大的减少了人工审核的数据量，同时提升了审核的准确率。


## 二、自动审核方案
上架审核需要审核的内容包括以下几点：
1. 商品展示图和对应的sku是否一致。
2. 商品拍摄是否清晰。
3. 商品是否贴了防拆标。
4. 商品是否脏污。
5. 商品是否处于图像中心区域。

针对需要审核需要，我们设计了如下解决方案

> | 需要审核的项目    |  解决方案      |
> | ---                          | ---       |
> |  商品展示图和对应的sku是否一致    |  图像匹配   |
> |  商品拍摄是否清晰                |  回归方案   |
> | 商品是否贴了防拆标               |   检测方案   |
> |   商品是否脏污                  | 检测方案     |
> |   商品是否处于图像中心区域        |  检测方案   |


## 1、商品展示图和对应的sku是否一致
商城售卖商品都需要对商品进行实物拍照展示，但是在商品上架到商城的过程中，会出现商品暂时图和对应的sku信息不匹配的情况。举个简单的例子，商品的sku信息是iphone11-红色，但是展示图却是iphoneX-绿色。
这个问题可以和图像分类问题对应上，相当于根据图像信息，确定商品类别。但是简单的使用分类算法无法很好的解决我们的问题。直接使用分类存在以下问题
>1. 类别是有限的，不管输入图像是否在类别中，输出都会有限的类别中
>2. 由于类别的固定，导致无法处理新类别商品

由于上面的问题，我们改变了策略，使用图像匹配的方案。包括学术中的face recgnize 或者person reidentification、Image Retrieval等方向。图像匹配主要是提取图像特征、图像相似度计算、排序、输出结果。其中图像特征提取这块是大家研究的重点方向，传统图像匹配特征包括SIFT、SURF、ORB特征等，基于深度学习的图像特征提取主要是CNN神经网络进行特征提取。下图给出了我们的方案：

[//]: # (<div align=center><img src="https://files.mdnice.com/user/36460/ac50ef79-6bc2-4335-9ca7-2ac0a473a862.svg" ></div> )

![商品suk审核方案](https://files.mdnice.com/user/36460/ac50ef79-6bc2-4335-9ca7-2ac0a473a862.svg)

**训练阶段：**
训练阶段主要是使用交叉熵损失联合三元组损失训练一个分类网络，其中骨干网络的选取我们尝试了monilenet、resnet、shufflenet、osnet等，整体来说还是resnet模型的精度略高。

$$ \begin{equation} 
L=-\frac 1N\sum_{i}^N{(y_i\log(p_i) + (1 - y_i)\log(1 - p_i))}
 \end{equation}$$
 
$$ \begin{equation}
L =\sum_{i}^N [||f(x_i^a)-f(x_i^p)||_2^2-||f(x_i^a)-f(x_i^n)||_2^2+\alpha ]_+  
\end{equation}$$ 

![三元组示例](https://files.mdnice.com/user/36460/c5b83829-c369-4e57-bad8-63efeec3fcc2.png)


公式1给出的是二分类交叉熵损失函数，其中$p_i$表示样本$i$的输出值，$y_i$表示样本$i$对应的标签。
公式2给出了三元组损失函数，$f(x_i^a)$ 表示锚点样本$i$对应的特征向量，$f(x_i^p)$表示与锚点样本$i$类别相同的样本对应的特征向量,$f(x_i^n)$表示与锚点样本$i$不同类别的样本对应的特征向量，$\alpha$表示特征空间内，不同的类簇之间的距离。


交叉熵损失函数是常见的分类损失函数，三元组损失函数是人脸识别，行人重识别中常用的损失函数。三元组损失函数及相关介绍感兴趣的同学可以查阅相关文献资料。我们解释下三元组损失函数带来的好处，三元组损失函数，可以使特征在特征空间呈现一簇一簇的特征，其带来的好处就是可以得到更加鲁棒的特征。

**测试阶段：**
测试阶段选取训练好的backbone，用来提取embedding特征。然后与gallery库中的特征计算相似度，得到排序列表，选取排序列表中top1图像对应的类别作为查询图像的类别输出。我们再构建gallery时，一个sku存放了三张图像，对应着不同的拍摄场景，因此我们对top5输出进行knn后得到查询图像对应的sku。

**上线运行：**
为了保证匹配算法输出的sku的准确性，我们输出了排序列表中的top1相似度，当相似度小于一定值threshold时，会输出报警信息，然后进行人工审核。这个策略保证了算法输出的sku信息一定是准确的。


## 2、商品拍摄是否清晰 
拍摄商品的过程中，由于商品移动或者没对好焦距，导致拍摄出的商品较为模糊。为了给用户带更好的购物体验，会在审核的过程中打回这些商品，重新拍出符合要求的商品图后才能上架。单纯针对图像拍照是否清晰，可以理解为图像分类问题。但是由于图像是否模糊的标注具有主观性，同时二分类无法很好的刻画出图像的模糊度，因此在实际的审核过程中，一线审核人员对于轻微模糊的图像往往会给出不同的判定结果，这类情况大大的影响了审核结果的一致性，导致商城中的商品展示效果有好有坏。

为了解决上面的问题，我们把图像的模糊度分为三个级别，模糊度由高到低分别是明显模糊、轻微模糊、清晰。并给出对应的分值，分别代表2，1，0分。同时多人对同一张图进行打分，并去掉同时出现明显模糊和清晰的图像，剩余的图像进行数值归一化，得到图像的模糊度分值。当让，我们可以把模糊程度细分为四类，比如明显模糊，轻微模糊、细微模糊、清晰，并且让更多的标注人员标注同一张图，这样我们可以得到更加细腻的标签值，这样也能带来更好的预测结果。但是鉴于资源有限，我们只把模糊度划分为三个级别，让三个同学进行标注。由此，我们把二分类问题转化为了回归问题，并且可以很好的隔离开业务标准。下面的表格给出了我们如何把分类任务变成回归任务。

> | 图片名    |  同学一打分  |同学二打分   |同学三打分   |总分(0-6)|归一化得分|
> | ---      | ---         | ---       | ---       |---     |--- |
> | 图片1     |  明显模糊   |轻微模糊    |    明显模糊  | 5  |5/6=0.83|
> | 图片2     |  轻微模糊   |轻微模糊    |   明显模糊   |4   |4/6=0.67  |
> | 图片3     |  清晰     |轻微模糊      |   清晰     |1    |0.17     |
> |   ...    |  ...       |...        |...       |...|.. .|


$$ \begin{equation}
MSE =\sum_{i}^N (y_i-\hat{y_i}) ^2 
\end{equation}$$ 

同样的，我们还是使用卷积神经网络，然后把分类损失函数变成回归损失函数，我们选用了MSE作为回归任务的损失函数,其中$\hat{y_i}$表示样本$i$的预测值，$y_i$表示样本的标签。

模型的输出值代表图像的模糊程度，我们把二分类任务变成回归任务后，可以带来诸多好处。首先就是算法开发与业务解耦合，不会因为业务标准的变更导致算法模型失效；同时业务方可以业务要求设置不同的模糊度阈值用来控制商城图像的清晰程度。

## 3、商品是否贴了防拆标、是否脏污、是否处于中心区域
针对商品是否贴了防拆标、是否脏污、是否处于中心区域问题，我们使用检测方案。这三个项中，较难的脏污的检测。因为脏污本身目标较小，且样本不易获取。针对这个问题，我们在数据收集的过程中选取了交互式数据标注方式，也叫

## 算法的应用策略
对于计算机视觉中常见的分类、检测等任务，我们无法同时保证模型的召回和精度同时达到100%的指标，因此在实际的应用过程中，需要结合实际业务，考虑选取模型是采用高精度还是高召回的状态。下图给出了召回率和精度的曲线图（图片来源于周志华老师的<机器学习>一书）

![PR曲线图](https://files.mdnice.com/user/36460/859e0e06-7e60-42d5-b48d-c3d552c469a5.png)

针对我们的审核业务，我们采取的是高召回策略，也就是保证模型可以尽量高的把不符合要求的商品图都找出来，其代价就是精度会相应的降低。我们召回有拍摄有问题商品后，会人工介入审核，因此那些被误召回的例子不会对业务造成影响。

在算法的加持下，目前上架审核同学的工作量降低了50%。经过算法的商品图像中，有50%的商品通过算法，可以直接上架到商城app，剩余的疑似有问题的商品都会被算法抓出来，然后人工复审。


## 三、总结
我们在第一节介绍了商品上架审核的背景，我们为什么要审核以及审核的内容，同时分析了当前业务中人工审核面临的一些问题，然后给出了算法赋能业务带来的好处。

在第二节，我们详细的介绍了算法模块。根据上架审核项的不同，我们采用了三种方式分别去解决三个不同的任务。并介绍了算法应用落地所选取的高召回率牺牲预测精度的方案，以及这种方案的可行性，最后给出了算法上线取得的效果。


